# Bug Squash 2: Fix Bugs from Roadmap

**Status**: Complete - Phases 1,2,3,5 Complete, Phase 4 Skipped
**Author**: @renato0307
**Created**: 2025-10-31

## Overview

Fix 8 bugs identified in the roadmap covering column sizing, navigation
behavior, filtering improvements, error handling, and resource operations.

## Research Summary

Research completed via Plan agent. Key findings:

1. **Column sizing**: 4 screens (configmaps, daemonsets, cronjobs, crds)
   have inconsistent column widths compared to working screens like pods
2. **PageUp/Down**: Delegates directly to table without ensuring cursor
   visibility
3. **Filter visibility**: After filtering, cursor may be out of viewport
4. **Item count**: Header has SetItemCount() but it's never called
5. **Filter sorting**: Fuzzy search returns ranked matches without sorting
6. **HPA YAML**: Command exists, likely namespace detection issue
7. **Multi-context errors**: First context failure causes exit, no
   graceful degradation
8. **Loading spinner**: Temporary error messages revert to loading state

## Implementation Phases

### Phase 1: Quick Wins (Column Sizing & Item Count) ✅

**Goal**: Fix visual issues with minimal risk

**Tasks**:
- [x] Fix ConfigMaps column widths (Name: 50, Data: 15, Age: 10)
- [x] Fix DaemonSets column widths (balance 6 columns across ~100 width)
- [x] Fix CronJobs column widths (Name: 50, Schedule: 20, others: 10)
- [x] Fix CRDs column widths (Group: 35, Version: 10, Kind: 30, others)
- [x] Wire up item count in App.Update() after RefreshCompleteMsg
- [x] Test all affected screens for proper column alignment

**Files**:
- `internal/screens/screens.go` (column configs)
- `internal/app/app.go` (item count wiring)

**Note**: Column sizing system needs architectural redesign for better
maintainability. Current implementation adjusted but not optimal. Future
design needed.

### Phase 2: Navigation Fixes (PageUp/Down & Filter Visibility) ✅

**Goal**: Ensure selected row always visible after navigation

**Tasks**:
- [x] Intercept PageUp/PageDown in ConfigScreen.DefaultUpdate()
- [x] After PageUp/Down, check if cursor needs viewport adjustment
- [x] After filtering in applyFilter(), ensure cursor is visible
- [x] Implemented ensureCursorVisible() method
- [x] Test with small terminal sizes (20 lines)

**Files**:
- `internal/screens/config.go` (DefaultUpdate, applyFilter)

**Technical approach**: Bubble Tea table doesn't expose viewport position,
so we may need to track visible range separately or use table.SetCursor()
strategically.

### Phase 3: Filtering Improvements (Sorting) ✅

**Goal**: Make filtered results predictable and scannable while preserving fuzzy ranking

**Tasks**:
- [x] Sort filtered results: score (desc) → age (desc) → name (asc)
- [x] Sort negation filter results by age, then name
- [x] Unfiltered list keeps repository order (already sorted by age)
- [x] Handle missing/zero Age fields gracefully
- [x] Test with large datasets (100+ items)

**Files**:
- `internal/screens/config.go` (applyFilter function)

**Implementation**:
- Normal fuzzy search: sorts by fuzzy score, then age, then name
- Negation filter: sorts by age, then name
- Unfiltered: preserves repository order

### Phase 4: Error Handling (Multi-Context & Connection Failures)

**Goal**: Graceful degradation and clear error communication

**Tasks**:
- [ ] Change initial context load to continue on failure (not exit)
- [ ] Add persistent error indicator to header for failed contexts
- [ ] Stop periodic refresh on sync errors (avoid spinner loop)
- [ ] Show "Failed to connect" state instead of "Loading..."
- [ ] Test with unreachable cluster context
- [ ] Test with multiple contexts where one fails

**Files**:
- `cmd/k1/main.go` (initial context loading)
- `internal/app/app.go` (context error handling)
- `internal/screens/config.go` (persistent error state)
- `internal/components/header.go` (error indicator display)

**Architecture consideration**: May need new message type for persistent
errors vs temporary errors.

### Phase 5: Investigation & Fix (HPA YAML) ✅

**Goal**: Verify HPA YAML works or fix specific bug

**Tasks**:
- [x] Verified HPAs exist in cluster (600+ HPAs found)
- [x] Investigated YAML command implementation
- [x] Found root cause: Missing GVR mappings for 5 resource types
- [x] Fixed DRY violation by removing duplicate function
- [x] Verified fix with build and tests

**Root Cause**: The `GetGVRForResourceType()` function in `repository.go`
was missing GVR mappings for 5 resource types:
- HorizontalPodAutoscalers (HPA)
- ReplicaSets
- PersistentVolumeClaims
- Ingresses
- Endpoints

This caused `/yaml` and `/describe` commands to fail with "Unknown resource
type" error for these resources.

**Deeper Issue - DRY Violation**: GVR information was duplicated in two
places:
- `getResourceRegistry()` in transforms.go (complete, had all resources)
- `GetGVRForResourceType()` in repository.go (incomplete, missing 5)

**Solution**: Removed the duplicate `GetGVRForResourceType()` function and
updated all 5 callers to use `GetResourceConfig().GVR` instead. This makes
`getResourceRegistry()` the single source of truth for all resource
configuration including GVR.

**Files Changed**:
- `internal/k8s/repository.go` - Deleted GetGVRForResourceType()
- `internal/commands/resource.go` - Updated YamlCommand and DescribeCommand
- `internal/screens/config.go` - Updated 3 informer-related functions

**Impact**: Fixed YAML/describe commands for 5 previously broken resource
types. Future resources will automatically work since they're registered
in one place.

## Testing Strategy

**Per-phase testing**:
- Phase 1: Visual inspection of all 4 screens + item count display
- Phase 2: Navigate with PageUp/Down, filter and navigate
- Phase 3: Filter large lists, verify alphabetical order
- Phase 4: Start with unreachable context, test error persistence
- Phase 5: Create real HPA, test YAML command

**Regression testing**:
- Ensure existing working screens not affected
- Verify filter mode still works correctly
- Check keyboard shortcuts (ctrl+y, ctrl+d) still work

## Success Criteria

- [x] All 4 screens have balanced column widths
- [x] Item count displays in title (e.g., "Pods (50)")
- [x] PageUp/Down keeps selected row visible
- [x] Filtering keeps selected row visible
- [x] Filtered results sorted by score, then age, then name
- [ ] Failed context doesn't exit app, shows persistent error (SKIPPED)
- [ ] Connection failures show error state, not infinite spinner (SKIPPED)
- [x] HPA YAML command works (Fixed + 4 other resources)

## TODO

**Phase 1** (Complete):
- [x] Fix column widths for 4 screens
- [x] Wire up item count display

**Phase 2** (Complete):
- [x] Fix PageUp/Down cursor visibility
- [x] Fix filter cursor visibility

**Phase 3** (Complete):
- [x] Sort filtered results

**Phase 4** (Skipped):
- [ ] Graceful multi-context error handling (deferred by user)
- [ ] Persistent error states (deferred by user)

**Phase 5** (Complete):
- [x] Found root cause: Missing GVR mappings
- [x] Fixed DRY violation by removing duplicate function
- [x] Fixed YAML/describe for 5 resource types

## Notes

- Follow test-first approach for each fix
- Update tests in screens_test.go for modified behavior
- Some fixes may require breaking down further during implementation
- Consider creating helper functions for cursor visibility logic (Phase 2)

## References

- Roadmap: `thoughts/shared/tickets/roadmap.md`
- Column sizing reference: Pods screen in `internal/screens/screens.go`
- Error handling: `ContextLoadFailedMsg` in `internal/app/app.go`
